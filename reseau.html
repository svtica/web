<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Outils r√©seau - Outils Sysadmin</title>
    <meta name="description" content="Outils r√©seau : identification IP, calculateur de sous-r√©seau, CIDR">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="fonts/font.css" type="text/css" charset="utf-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <!-- CSS Unifi√© -->
    <link rel="stylesheet" href="css/unified-theme.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/favicon.png">
    
    <!-- Scripts -->
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery-ui.min.js" type="text/javascript"></script>
</head>
<body>
    <!-- Arri√®re-plans anim√©s -->
    <div class="background"></div>
    <div class="grid"></div>
    
    <!-- Navigation (sera g√©n√©r√©e automatiquement) -->
    <nav id="main-navigation">
        <!-- La navigation sera inject√©e ici par navigation.js -->
    </nav>
    
    <!-- Contenu principal -->
    <div class="container fade-in">
        <div class="row">
            <h1>Outils r√©seau</h1>

            <div class="network-tools">
                <!-- Section IP am√©lior√©e avec API autonome -->
                <div class="tool-section">
                    <h4>üåê Mon adresse IP</h4>
                    <div class="ip-options">
                        <div class="toggle-group">
                            <label class="toggle-label">
                                <input type="radio" name="ipService" value="autonomous" checked>
                                <span>Service autonome (gratuit)</span>
                            </label>
                            <label class="toggle-label">
                                <input type="radio" name="ipService" value="fallback">
                                <span>Service externe (ip-api.com)</span>
                            </label>
                        </div>
                        <button class="button secondary" onclick="refreshIPInfo()">üîÑ Actualiser</button>
                    </div>
                    <div id="myIP">Chargement des informations IP...</div>
                    <div id="ipServiceStatus" class="service-status"></div>
                </div>

                <!-- Nouvelle section de recherche IP -->
                <div class="tool-section">
                    <h4>üîç Recherche d'adresse IP</h4>
                    <div class="ip-lookup-form">
                        <div class="form-group">
                            <label for="lookupIP">Adresse IP √† rechercher:</label>
                            <div class="input-with-button">
                                <input type="text" id="lookupIP" placeholder="Ex: 8.8.8.8, 1.1.1.1" />
                                <button class="button" onclick="performIPLookup()">üîç Rechercher</button>
                            </div>
                        </div>
                        <div id="lookupResult" class="lookup-result" style="display: none;"></div>
                    </div>
                </div>

                <div class="tool-section">
                    <h4>üßÆ Calculateur de sous-r√©seau</h4>
                    <form class="subnet-form">
                        <div class="form-group">
                            <label for="ipAddress">Adresse IP:</label>
                            <input type="text" id="ipAddress" name="ipAddress" placeholder="Ex: 192.168.0.1" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="cidr">Masque CIDR:</label>
                            <select id="cidr">
                                <option value="0">0.0.0.0/0</option>
                                <option value="1">128.0.0.0/1</option>
                                <option value="2">192.0.0.0/2</option>
                                <option value="3">224.0.0.0/3</option>
                                <option value="4">240.0.0.0/4</option>
                                <option value="5">248.0.0.0/5</option>
                                <option value="6">252.0.0.0/6</option>
                                <option value="7">254.0.0.0/7</option>
                                <option value="8">255.0.0.0/8</option>
                                <option value="9">255.128.0.0/9</option>
                                <option value="10">255.192.0.0/10</option>
                                <option value="11">255.224.0.0/11</option>
                                <option value="12">255.240.0.0/12</option>
                                <option value="13">255.248.0.0/13</option>
                                <option value="14">255.252.0.0/14</option>
                                <option value="15">255.254.0.0/15</option>
                                <option value="16">255.255.0.0/16</option>
                                <option value="17">255.255.128.0/17</option>
                                <option value="18">255.255.192.0/18</option>
                                <option value="19">255.255.224.0/19</option>
                                <option value="20">255.255.240.0/20</option>
                                <option value="21">255.255.248.0/21</option>
                                <option value="22">255.255.252.0/22</option>
                                <option value="23">255.255.254.0/23</option>
                                <option value="24" selected>255.255.255.0/24</option>
                                <option value="25">255.255.255.128/25</option>
                                <option value="26">255.255.255.192/26</option>
                                <option value="27">255.255.255.224/27</option>
                                <option value="28">255.255.255.240/28</option>
                                <option value="29">255.255.255.248/29</option>
                                <option value="30">255.255.255.252/30</option>
                                <option value="31">255.255.255.254/31</option>
                                <option value="32">255.255.255.255/32</option>
                            </select>
                        </div>
                        
                        <button type="submit" onclick="calculateResults(event)" class="button">Calculer</button>
                    </form>

                    <div id="networkDetails" class="results-section" style="display: none;">
                        <h5>R√©sultats du calcul de sous-r√©seau:</h5>
                        <div class="results-grid">
                            <div class="result-item">
                                <strong>Adresse r√©seau:</strong>
                                <span id="networkAddress"></span>
                            </div>
                            <div class="result-item">
                                <strong>Adresse de diffusion:</strong>
                                <span id="broadcastAddress"></span>
                            </div>
                            <div class="result-item">
                                <strong>Masque de sous-r√©seau:</strong>
                                <span id="subnetMask"></span>
                            </div>
                            <div class="result-item">
                                <strong>Nombre d'h√¥tes utilisables:</strong>
                                <span id="usableHosts"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations sur la base de donn√©es -->
                <div class="tool-section">
                    <h4>‚ÑπÔ∏è Information sur la g√©olocalisation IP</h4>
                    <div class="db-info">
                        <p><strong>Service autonome:</strong> Utilise la base de donn√©es <a href="https://github.com/sapics/ip-location-db" target="_blank">ip-location-db</a></p>
                        <p><strong>Avantages:</strong> Gratuit, sans limite de requ√™tes, respecte la vie priv√©e</p>
                        <p><strong>Pr√©cision:</strong> ~95% au niveau pays, ~80% au niveau ville</p>
                        <p><strong>Mise √† jour:</strong> Donn√©es actualis√©es automatiquement depuis les registres RIR</p>
                        <div id="dbLoadStatus" class="load-status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/unified-theme-manager.js"></script>
    <script src="js/navigation.js"></script>
    
    <!-- Script de g√©olocalisation IP autonome -->
    <script>
        // Configuration de l'API autonome
        const AutonomousIPService = {
            // URLs des bases de donn√©es
            databases: {
                country: 'https://raw.githubusercontent.com/sapics/ip-location-db/main/dbip-country/dbip-country-ipv4.csv',
                city: 'https://raw.githubusercontent.com/sapics/ip-location-db/main/dbip-city/dbip-city-ipv4.csv'
            },
            
            // Cache
            cache: new Map(),
            cacheExpiry: 24 * 60 * 60 * 1000, // 24 heures
            
            // Base de donn√©es en m√©moire
            ipDatabase: null,
            dbLoadTime: null,

            // Services IP publique
            async getPublicIP() {
                const services = [
                    'https://api.ipify.org?format=json',
                    'https://jsonip.com',
                    'https://httpbin.org/ip'
                ];
                
                for (const service of services) {
                    try {
                        const response = await fetch(service, { timeout: 5000 });
                        const data = await response.json();
                        return data.ip || data.origin;
                    } catch (e) {
                        continue;
                    }
                }
                throw new Error('Services IP indisponibles');
            },

            // Convertir IP en nombre
            ipToNumber(ip) {
                return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet), 0) >>> 0;
            },

            // Charger la base de donn√©es (version simplifi√©e pour la d√©mo)
            async loadDatabase() {
                if (this.ipDatabase && this.dbLoadTime && 
                    (Date.now() - this.dbLoadTime < this.cacheExpiry)) {
                    return this.ipDatabase;
                }

                try {
                    this.updateStatus('Chargement de la base de donn√©es IP...', 'loading');
                    
                    // Chargement limit√© pour la d√©mo (premiers 2000 enregistrements)
                    const response = await fetch(this.databases.country);
                    const csvData = await response.text();
                    
                    const lines = csvData.split('\n').slice(0, 2000);
                    const database = [];
                    
                    for (const line of lines) {
                        if (line.trim()) {
                            const [startIP, endIP, country, countryName] = line.split(',');
                            if (startIP && endIP && country) {
                                database.push({
                                    startIP: this.ipToNumber(startIP.replace(/"/g, '')),
                                    endIP: this.ipToNumber(endIP.replace(/"/g, '')),
                                    country: country.replace(/"/g, ''),
                                    countryName: countryName?.replace(/"/g, '') || 'Inconnu'
                                });
                            }
                        }
                    }
                    
                    // Trier par startIP pour la recherche binaire
                    database.sort((a, b) => a.startIP - b.startIP);
                    
                    this.ipDatabase = database;
                    this.dbLoadTime = Date.now();
                    this.updateStatus(`Base de donn√©es charg√©e: ${database.length} entr√©es`, 'success');
                    
                    return database;
                } catch (error) {
                    console.error('Erreur DB:', error);
                    this.updateStatus('Erreur de chargement. Utilisation du service de fallback.', 'error');
                    return null;
                }
            },

            // Rechercher une IP dans la base
            findIPLocation(ip, database) {
                if (!database) return null;
                
                const ipNum = this.ipToNumber(ip);
                let left = 0;
                let right = database.length - 1;
                
                while (left <= right) {
                    const mid = Math.floor((left + right) / 2);
                    const entry = database[mid];
                    
                    if (ipNum >= entry.startIP && ipNum <= entry.endIP) {
                        return {
                            ip: ip,
                            country: entry.country,
                            countryName: entry.countryName,
                            source: 'Base autonome'
                        };
                    } else if (ipNum < entry.startIP) {
                        right = mid - 1;
                    } else {
                        left = mid + 1;
                    }
                }
                
                return null;
            },

            // Service de fallback
            async fallbackLookup(ip) {
                try {
                    const response = await fetch(`http://ip-api.com/json/${ip || ''}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        return {
                            ip: data.query,
                            country: data.countryCode,
                            countryName: data.country,
                            region: data.regionName,
                            city: data.city,
                            isp: data.isp,
                            org: data.org,
                            timezone: data.timezone,
                            lat: data.lat,
                            lon: data.lon,
                            zip: data.zip,
                            as: data.as,
                            source: 'API externe'
                        };
                    }
                } catch (error) {
                    console.error('Erreur fallback:', error);
                }
                return null;
            },

            // Recherche principale
            async lookup(ip) {
                const useAutonomous = document.querySelector('input[name="ipService"]:checked').value === 'autonomous';
                
                if (useAutonomous) {
                    const database = await this.loadDatabase();
                    let result = this.findIPLocation(ip, database);
                    
                    if (!result) {
                        // Si pas trouv√©, essayer le fallback
                        result = await this.fallbackLookup(ip);
                        if (result) result.source += ' (fallback)';
                    }
                    
                    return result;
                } else {
                    return await this.fallbackLookup(ip);
                }
            },

            // Mettre √† jour le statut
            updateStatus(message, type = 'info') {
                const statusEl = document.getElementById('dbLoadStatus');
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = `load-status ${type}`;
                }
                
                const serviceStatusEl = document.getElementById('ipServiceStatus');
                if (serviceStatusEl) {
                    serviceStatusEl.textContent = message;
                    serviceStatusEl.className = `service-status ${type}`;
                }
            }
        };

        // Formater les informations IP
        function formatIPInfo(data) {
            if (!data) {
                return "<span style='color: var(--error-color);'>‚ùå Aucune information trouv√©e</span>";
            }

            let html = "<strong>üåê Adresse IP:</strong> " + data.ip + "<br>";
            html += "<strong>üá∫üá≥ Pays:</strong> " + (data.countryName || 'Inconnu') + " (" + (data.country || 'N/A') + ")<br>";
            
            if (data.region) html += "<strong>üìç R√©gion:</strong> " + data.region + "<br>";
            if (data.city) html += "<strong>üèôÔ∏è Ville:</strong> " + data.city + "<br>";
            if (data.isp) html += "<strong>üåê FAI:</strong> " + data.isp + "<br>";
            if (data.org) html += "<strong>üè¢ Organisation:</strong> " + data.org + "<br>";
            if (data.timezone) html += "<strong>üïê Fuseau horaire:</strong> " + data.timezone + "<br>";
            if (data.lat && data.lon) html += "<strong>üìç Coordonn√©es:</strong> " + data.lat + ", " + data.lon + "<br>";
            if (data.zip) html += "<strong>üìÆ Code postal:</strong> " + data.zip + "<br>";
            if (data.as) html += "<strong>üî¢ ASN:</strong> " + data.as + "<br>";
            
            html += "<br><em>üìä Source: " + (data.source || 'Inconnue') + "</em>";
            
            return html;
        }

        // Actualiser les informations IP
        async function refreshIPInfo() {
            const infoEl = document.getElementById("myIP");
            infoEl.innerHTML = "üîÑ Chargement des informations IP...";
            
            try {
                const ip = await AutonomousIPService.getPublicIP();
                const info = await AutonomousIPService.lookup(ip);
                infoEl.innerHTML = formatIPInfo(info);
            } catch (error) {
                infoEl.innerHTML = "<span style='color: var(--error-color);'>‚ùå Erreur: " + error.message + "</span>";
            }
        }

        // Recherche d'IP personnalis√©e
        async function performIPLookup() {
            const ip = document.getElementById('lookupIP').value.trim();
            const resultEl = document.getElementById('lookupResult');
            
            if (!ip) {
                alert('Veuillez entrer une adresse IP');
                return;
            }
            
            // Validation IP
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!ipRegex.test(ip)) {
                alert('Format d\'adresse IP invalide');
                return;
            }
            
            resultEl.style.display = 'block';
            resultEl.innerHTML = 'üîç Recherche en cours...';
            
            try {
                const info = await AutonomousIPService.lookup(ip);
                resultEl.innerHTML = formatIPInfo(info);
            } catch (error) {
                resultEl.innerHTML = "<span style='color: var(--error-color);'>‚ùå Erreur: " + error.message + "</span>";
            }
        }

        // Permettre Enter pour la recherche
        document.addEventListener('DOMContentLoaded', function() {
            const lookupInput = document.getElementById('lookupIP');
            if (lookupInput) {
                lookupInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performIPLookup();
                    }
                });
            }
            
            // Charger les infos IP au d√©marrage
            refreshIPInfo();
        });
    </script>
    
    <!-- Script de calcul r√©seau (inchang√©) -->
    <script>
        function calculateResults(event) {
            event.preventDefault();

            var ipAddress = document.getElementById("ipAddress").value;
            var cidr = document.getElementById("cidr").value;
            
            if (!isValidIP(ipAddress)) {
                alert("Veuillez entrer une adresse IP valide (ex: 192.168.1.1)");
                return;
            }

            var subnetMask = calculateSubnetMask(cidr);
            var broadcastAddress = calculateBroadcastAddress(ipAddress, cidr);
            var networkAddress = calculateNetworkAddress(ipAddress, cidr);
            var usableHosts = calculateUsableHosts(cidr);

            function isValidIP(ip) {
                var regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
                return regex.test(ip);
            }

            function calculateSubnetMask(cidr) {
                var networkBits = parseInt(cidr);
                var subnetMask = "";

                for (var i = 0; i < 4; i++) {
                    if (networkBits >= 8) {
                        subnetMask += "255";
                        networkBits -= 8;
                    } else if (networkBits > 0) {
                        var subnetBits = 8 - networkBits;
                        var subnetValue = 256 - Math.pow(2, subnetBits);
                        subnetMask += subnetValue.toString();
                        networkBits = 0;
                    } else {
                        subnetMask += "0";
                    }

                    if (i < 3) {
                        subnetMask += ".";
                    }
                }

                return subnetMask;
            }

            function calculateBroadcastAddress(ipAddress, cidr) {
                var n_ipParts = ipAddress.split('.').map(Number);
                var n_maskParts = calculateSubnetMask(cidr).split('.').map(Number);

                var invertedMaskParts = n_maskParts.map(function (n_maskPart) {
                    return 255 - n_maskPart;
                });

                var broadcastParts = n_ipParts.map(function (n_ipPart, i) {
                    return n_ipPart | invertedMaskParts[i];
                });

                return broadcastParts.join('.');
            }

            function calculateNetworkAddress(ipAddress, cidr) {
                var n_ipParts = ipAddress.split('.').map(Number);
                var n_maskParts = calculateSubnetMask(cidr).split('.').map(Number);

                var networkParts = n_ipParts.map(function (n_ipPart, i) {
                    return n_ipPart & n_maskParts[i];
                });

                return networkParts.join('.');
            }

            function calculateUsableHosts(cidr) {
                var hostBits = 32 - parseInt(cidr);
                return Math.pow(2, hostBits) - 2;
            }

            document.getElementById("networkAddress").textContent = networkAddress;
            document.getElementById("broadcastAddress").textContent = broadcastAddress;
            document.getElementById("subnetMask").textContent = subnetMask;
            document.getElementById("usableHosts").textContent = usableHosts.toLocaleString();

            document.getElementById("networkDetails").style.display = "block";
        }
    </script>
    
    <!-- Styles sp√©cifiques am√©lior√©s -->
    <style>
        .network-tools {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xl);
        }
        
        .tool-section {
            background: var(--highlight-color);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .tool-section h4 {
            margin-top: 0;
            color: var(--heading-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: var(--spacing-sm);
            font-size: 1.3em;
        }
        
        .ip-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        
        .toggle-group {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            color: var(--text-color);
        }
        
        .toggle-label input[type="radio"] {
            margin: 0;
        }
        
        .ip-lookup-form {
            max-width: 600px;
        }
        
        .input-with-button {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .input-with-button input {
            flex: 1;
            min-width: 200px;
        }
        
        .lookup-result {
            background: var(--bg-color);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-top: var(--spacing-md);
            font-family: monospace;
            line-height: 1.6;
        }
        
        .service-status, .load-status {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .service-status.loading, .load-status.loading {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border-left: 3px solid #ffc107;
        }
        
        .service-status.success, .load-status.success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border-left: 3px solid #28a745;
        }
        
        .service-status.error, .load-status.error {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border-left: 3px solid #dc3545;
        }
        
        .subnet-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 500px;
            margin-bottom: var(--spacing-lg);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .form-group label {
            font-weight: bold;
            color: var(--text-color);
        }
        
        .results-section {
            background: var(--bg-color);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-top: var(--spacing-lg);
        }
        
        .results-section h5 {
            margin-top: 0;
            color: var(--heading-color);
        }
        
        .results-grid {
            display: grid;
            gap: var(--spacing-md);
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .result-item {
            padding: var(--spacing-sm);
            background: var(--highlight-color);
            border-radius: var(--border-radius);
        }
        
        .result-item strong {
            color: var(--heading-color);
            display: block;
            margin-bottom: var(--spacing-xs);
        }
        
        #myIP {
            background: var(--bg-color);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            font-family: monospace;
            line-height: 1.8;
            margin-bottom: var(--spacing-sm);
        }
        
        .db-info {
            background: var(--bg-color);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            line-height: 1.6;
        }
        
        .db-info a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        .db-info a:hover {
            text-decoration: underline;
        }
        
        .button.secondary {
            background: var(--border-color);
            color: var(--text-color);
        }
        
        .button.secondary:hover {
            background: var(--accent-color);
            color: var(--bg-color);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .subnet-form, .ip-lookup-form {
                max-width: 100%;
            }
            
            .ip-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .input-with-button {
                flex-direction: column;
            }
            
            .input-with-button input {
                min-width: auto;
            }
        }
        
        /* Effets sp√©ciaux pour le mode retro */
        :root[data-theme="retro"] .tool-section {
            border-color: var(--border-color);
            background: rgba(0, 255, 159, 0.05);
        }
        
        :root[data-theme="retro"] .results-section {
            box-shadow: 0 0 15px rgba(0, 255, 159, 0.3);
        }
        
        :root[data-theme="retro"] #myIP {
            box-shadow: 0 0 10px rgba(0, 255, 159, 0.2);
        }
        
        :root[data-theme="retro"] .lookup-result {
            box-shadow: 0 0 10px rgba(0, 255, 159, 0.2);
        }
    </style>
    
    <!-- Initialisation -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('unified-theme')) {
                localStorage.setItem('unified-theme', 'dark');
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        });
    </script>
</body>
</html>